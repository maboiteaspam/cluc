<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>/home/maboiteaspam/Bureau/cluc/lib/cluc-childprocess-context.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Cluc.html">Cluc</a></li>
                                <li><a href="../classes/ClucAnswer.html">ClucAnswer</a></li>
                                <li><a href="../classes/ClucChildProcess.html">ClucChildProcess</a></li>
                                <li><a href="../classes/ClucConfirm.html">ClucConfirm</a></li>
                                <li><a href="../classes/ClucContext.html">ClucContext</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/ClucDieOnError.html">ClucDieOnError</a></li>
                                <li><a href="../classes/ClucDisplay.html">ClucDisplay</a></li>
                                <li><a href="../classes/ClucMustNot.html">ClucMustNot</a></li>
                                <li><a href="../classes/ClucProgress.html">ClucProgress</a></li>
                                <li><a href="../classes/ClucRule.html">ClucRule</a></li>
                                <li><a href="../classes/ClucSpin.html">ClucSpin</a></li>
                                <li><a href="../classes/ClucSpinUntil.html">ClucSpinUntil</a></li>
                                <li><a href="../classes/ClucSsh.html">ClucSsh</a></li>
                                <li><a href="../classes/ClucSSHContext.html">ClucSSHContext</a></li>
                                <li><a href="../classes/ClucSuccess.html">ClucSuccess</a></li>
                                <li><a href="../classes/ClucWarn.html">ClucWarn</a></li>
                                <li><a href="../classes/ClucWatch.html">ClucWatch</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: /home/maboiteaspam/Bureau/cluc/lib/cluc-childprocess-context.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

var _ = require(&#x27;underscore&#x27;);
var byline = require(&#x27;byline&#x27;);
var pkg = require(&#x27;../package.json&#x27;);
var debug = require(&#x27;debug&#x27;)(pkg.name);

var ClucContext = (function(){

  var ClucRules = require(&#x27;./cluc-rules.js&#x27;);
  var ClucRule = ClucRules.rule;

  /**
   * Context of a command
   * Helps to analyze and respond
   * to the input stream from spawned process
   *
   * @class ClucContext
   */
  var ClucContext = function(){
    this.init();
  };
  ClucContext.prototype.init = function(cmd, savedValues){
    if(!this.hasRunOnce){
      this.canDo = 1;
      this.hasRunOnce = false;
    }
    this.cmd = cmd  || null;
    this.stdin = null;
    this.rules = [];
    this.failedRules = [];
    this.savedValues = _.extend({}, savedValues);
  };

  ClucContext.prototype.getValue = function(name){
    return this.savedValues[name];
  };

  ClucContext.prototype.saveValue = function(name, value){
    this.savedValues[name] = value;
  };

  ClucContext.prototype.pushRule = function(Rule, initArgs ){
    var rule = new Rule();
    rule.init.apply(rule, initArgs);
    this.rules.push(rule);
    return rule;
  };

  ClucContext.prototype.captureValue = function(name, search, fn){
    var rule = new ClucRule();
    rule.init(search);
    var that = this;
    rule.onceMatch = function(){
      if(fn){
        fn(name, rule.matched);
      }else{
        that.saveValue(name, rule.matched[1]);
      }
    };
    this.rules.push(rule);
    return rule;
  };
  ClucContext.prototype.captureOnce = function(search, error, fn){
    var rule = new ClucRule();
    rule.init(search, error);
    rule.onceMatch = fn;
    this.rules.push(rule);
    return rule;
  };
  ClucContext.prototype.capture = function(search, error, fn){
    var rule = new ClucRule();
    rule.init(search, error);
    rule.onData = fn;
    this.rules.push(rule);
    return rule;
  };
  ClucContext.prototype.miss = function(search, error, fn){
    var rule = new ClucRule();
    rule.init(search, error);
    rule.onClose = function(){
      if(!rule.matched){
        fn(rule);
      }
    };
    this.rules.push(rule);
    return rule;
  };

  ClucContext.prototype.must = function(search, error){
    return this.pushRule(ClucRules.must, arguments);
  };
  ClucContext.prototype.success = function(search, success ){
    return this.pushRule(ClucRules.success, arguments);
  };
  ClucContext.prototype.confirm = function(search, confirm ){
    return this.pushRule(ClucRules.confirm, arguments);
  };
  ClucContext.prototype.mustnot = function(search, error ){
    return this.pushRule(ClucRules.mustnot, arguments);
  };
  ClucContext.prototype.warn = function(search, warn ){
    return this.pushRule(ClucRules.warn, arguments);
  };

  ClucContext.prototype.watch = function(search, confirm ){
    return this.pushRule(ClucRules.watch, arguments);
  };
  ClucContext.prototype.spin = function(search ){
    return this.pushRule(ClucRules.spin, arguments);
  };
  ClucContext.prototype.spinUntil = function(search ){
    return this.pushRule(ClucRules.spinUntil, arguments);
  };
  ClucContext.prototype.progress = function(search ){
    return this.pushRule(ClucRules.progress, arguments);
  };
  ClucContext.prototype.answer = function(q, a){
    return this.pushRule(ClucRules.answer, arguments);
  };
  ClucContext.prototype.display = function(){
    return this.pushRule(ClucRules.display, [/.*/g]);
  };
  ClucContext.prototype.dieOnError = function(){
    return this.pushRule(ClucRules.dieOnError, [/.*/g]);
  };
  ClucContext.prototype.redo = function(max){
    if(!this.hasRunOnce){
      this.canDo = max;
    }
    return this;
  };



  ClucContext.prototype.executeRules = function(error, stdout, stderr, stdin){
    var rules = this.rules;
    var failedRules = this.failedRules;

    rules.forEach(function(rule){
      rule.stdin = stdin;
    });
    if(_.isString(stdout)){

      try{
        if(this.cmd.fn) this.cmd.fn.call(this, error, stdout, stderr);
      }catch(ex){
        throw ex; // shall it be voided?
      }

      var matched = false;
      rules.forEach(function(rule){
        matched = rule.testData(stdout, &#x27;stdout&#x27;, matched) || matched;
        matched = rule.testData(stderr, &#x27;stderr&#x27;, matched) || matched;
      });

      rules.forEach(function(rule){
        rule.close();
        if(rule.hasFailed()) failedRules.push(rule);
      });

    } else if(stdout){

      byline(stdout).on(&#x27;data&#x27; , function(d){
        var matched = false;
        rules.forEach(function(rule){
          matched = rule.testData((&#x27;&#x27;+d), &#x27;stdout&#x27;, matched) || matched;
        });
      });
      byline(stderr).on(&#x27;data&#x27; , function(d){
        rules.forEach(function(rule){
          matched = rule.testData((&#x27;&#x27;+d), &#x27;stderr&#x27;, matched) || matched;
        });
      });

      stdout.on(&#x27;close&#x27; , function(){
        process.nextTick(function(){
          var matched = false;
          rules.forEach(function(rule){
            rule.close(matched);
            matched = rule.matched || matched;
            if(rule.hasFailed()) failedRules.push(rule);
            rule.stdin = null;
          });
        })
      });

      try{
        if(this.cmd.fn) this.cmd.fn.call(this, error, stdout, stderr);
      }catch(ex){
        throw ex; // shall it be voided?
      }

    }else{
      debug(&#x27;something is wrong stdout is null&#x27;)
    }
    this.hasRunOnce = true;
    this.canDo--;

    return this.hasFailed();
  };

  ClucContext.prototype.canRedo = function(){
    return this.canDo&gt;0;
  };

  ClucContext.prototype.hasFailed = function(){
    return this.failedRules.length&gt;0;
  };

  ClucContext.prototype.getOrRules = function(){
    var orFn = [];
    this.failedRules.forEach(function(rule){
      if(rule.orFn){
        orFn.push(rule);
      }
    });
    return orFn;
  };

  return ClucContext;
})();

module.exports = ClucContext;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
